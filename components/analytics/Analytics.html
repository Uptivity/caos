<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - CAOS CRM</title>
    <link rel="stylesheet" href="../../styles/snowui.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        /* Analytics Component - Built on SnowUI Design System */

        /* Layout Structure */
        .analytics-container {
            min-height: 100vh;
            background: var(--snow-gray-50);
        }

        .analytics-header {
            background: var(--snow-white);
            border-bottom: 1px solid var(--snow-gray-200);
            padding: var(--space-4) var(--space-6);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .header-title {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--snow-gray-900);
            margin: 0;
        }

        .header-subtitle {
            font-size: var(--text-sm);
            color: var(--snow-gray-600);
            margin: 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
        }

        /* Filters Section */
        .filters-section {
            background: var(--snow-white);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-6);
            border: 1px solid var(--snow-gray-200);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            align-items: end;
        }

        /* Metrics Overview */
        .metrics-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .metric-card {
            background: var(--snow-white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            border: 1px solid var(--snow-gray-200);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--snow-blue-500);
        }

        .metric-card.revenue::before { background: var(--snow-green-500); }
        .metric-card.conversion::before { background: var(--snow-purple-500); }
        .metric-card.activity::before { background: var(--snow-orange-500); }

        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
        }

        .metric-title {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--snow-gray-600);
            margin: 0;
        }

        .metric-icon {
            width: 20px;
            height: 20px;
            color: var(--snow-gray-400);
        }

        .metric-value {
            font-size: var(--text-3xl);
            font-weight: 700;
            color: var(--snow-gray-900);
            margin-bottom: var(--space-2);
        }

        .metric-change {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--text-sm);
        }

        .metric-change.positive { color: var(--snow-green-600); }
        .metric-change.negative { color: var(--snow-red-600); }
        .metric-change.neutral { color: var(--snow-gray-500); }

        .change-arrow {
            width: 16px;
            height: 16px;
        }

        /* Chart Sections */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .chart-card {
            background: var(--snow-white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            border: 1px solid var(--snow-gray-200);
            min-height: 400px;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--snow-gray-100);
        }

        .chart-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--snow-gray-900);
            margin: 0;
            flex: 1;
        }

        .chart-actions {
            display: flex;
            gap: var(--space-2);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Full Width Charts */
        .chart-full {
            grid-column: 1 / -1;
        }

        /* Reports Section */
        .reports-section {
            background: var(--snow-white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            border: 1px solid var(--snow-gray-200);
            margin-bottom: var(--space-6);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }

        .section-title {
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--snow-gray-900);
            margin: 0;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-4);
        }

        .report-card {
            border: 1px solid var(--snow-gray-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .report-card:hover {
            border-color: var(--snow-blue-300);
            background: var(--snow-blue-50);
        }

        .report-title {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--snow-gray-900);
            margin-bottom: var(--space-1);
        }

        .report-description {
            font-size: var(--text-sm);
            color: var(--snow-gray-600);
            margin-bottom: var(--space-3);
        }

        .report-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: var(--text-sm);
            color: var(--snow-gray-500);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                gap: var(--space-3);
                align-items: stretch;
            }

            .header-actions {
                justify-content: center;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--snow-gray-500);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--snow-gray-200);
            border-top-color: var(--snow-blue-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: var(--space-2);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error States */
        .error-state {
            text-align: center;
            padding: var(--space-8);
            color: var(--snow-red-600);
        }

        .error-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto var(--space-4);
            color: var(--snow-red-400);
        }

        /* Export Modal */
        .export-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .export-modal.active {
            display: flex;
        }

        .export-content {
            background: var(--snow-white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .export-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--snow-gray-100);
        }

        .export-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--snow-gray-900);
            margin: 0;
        }

        .export-options {
            display: grid;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .export-actions {
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="analytics-container">
        <!-- Header -->
        <header class="analytics-header">
            <div class="header-content">
                <div class="header-left">
                    <div>
                        <h1 class="header-title">Analytics</h1>
                        <p class="header-subtitle">Data insights and performance metrics</p>
                    </div>
                </div>
                <div class="header-actions">
                    <select id="dateRangeSelect" class="select">
                        <option value="7d">Last 7 days</option>
                        <option value="30d" selected>Last 30 days</option>
                        <option value="90d">Last 90 days</option>
                    </select>
                    <button class="btn btn-outline" onclick="refreshData()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                    <button class="btn btn-primary" onclick="openExportModal()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Metrics Overview -->
            <section class="metrics-overview">
                <div class="metric-card leads">
                    <div class="metric-header">
                        <h3 class="metric-title">Total Leads</h3>
                        <svg class="metric-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="metric-value" id="totalLeadsValue">---</div>
                    <div class="metric-change positive" id="totalLeadsChange">
                        <svg class="change-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                        <span>--</span>
                    </div>
                </div>

                <div class="metric-card revenue">
                    <div class="metric-header">
                        <h3 class="metric-title">Total Revenue</h3>
                        <svg class="metric-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="metric-value" id="totalRevenueValue">---</div>
                    <div class="metric-change positive" id="totalRevenueChange">
                        <svg class="change-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                        <span>--</span>
                    </div>
                </div>

                <div class="metric-card conversion">
                    <div class="metric-header">
                        <h3 class="metric-title">Conversion Rate</h3>
                        <svg class="metric-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div class="metric-value" id="conversionRateValue">---</div>
                    <div class="metric-change neutral" id="conversionRateChange">
                        <svg class="change-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                        <span>--</span>
                    </div>
                </div>

                <div class="metric-card activity">
                    <div class="metric-header">
                        <h3 class="metric-title">Active Users</h3>
                        <svg class="metric-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="metric-value" id="activeUsersValue">---</div>
                    <div class="metric-change positive" id="activeUsersChange">
                        <svg class="change-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                        <span>--</span>
                    </div>
                </div>
            </section>

            <!-- Charts Section -->
            <section class="charts-grid">
                <!-- Revenue Trend Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Revenue Trend</h3>
                        <div class="chart-actions">
                            <button class="btn btn-sm btn-outline" onclick="toggleChartType('revenue')">Toggle View</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="revenueTrendChart"></canvas>
                    </div>
                </div>

                <!-- Lead Sources Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Lead Sources</h3>
                        <div class="chart-actions">
                            <button class="btn btn-sm btn-outline" onclick="toggleChartType('sources')">Toggle View</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="leadSourcesChart"></canvas>
                    </div>
                </div>

                <!-- Sales Funnel Chart -->
                <div class="chart-card chart-full">
                    <div class="chart-header">
                        <h3 class="chart-title">Sales Pipeline Funnel</h3>
                        <div class="chart-actions">
                            <button class="btn btn-sm btn-outline" onclick="refreshFunnel()">Refresh</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="salesFunnelChart"></canvas>
                    </div>
                </div>

                <!-- Campaign Performance Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Campaign Performance</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="campaignChart"></canvas>
                    </div>
                </div>

                <!-- User Activity Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">User Activity</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="userActivityChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section class="reports-section">
                <div class="section-header">
                    <h2 class="section-title">Available Reports</h2>
                    <button class="btn btn-primary" onclick="createCustomReport()">Create Report</button>
                </div>
                <div class="reports-grid" id="reportsGrid">
                    <!-- Reports will be loaded here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Export Modal -->
    <div class="export-modal" id="exportModal">
        <div class="export-content">
            <div class="export-header">
                <h3 class="export-title">Export Analytics Data</h3>
                <button class="btn btn-text" onclick="closeExportModal()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="export-options">
                <div class="form-group">
                    <label class="form-label">Report</label>
                    <select id="exportReport" class="select">
                        <option value="">Select a report...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Format</label>
                    <select id="exportFormat" class="select">
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date Range</label>
                    <select id="exportDateRange" class="select">
                        <option value="7d">Last 7 days</option>
                        <option value="30d">Last 30 days</option>
                        <option value="90d">Last 90 days</option>
                    </select>
                </div>
            </div>
            <div class="export-actions">
                <button class="btn btn-outline" onclick="closeExportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="executeExport()">Export</button>
            </div>
        </div>
    </div>

    <script>
        // Analytics Application State
        const AnalyticsApp = {
            currentDateRange: '30d',
            charts: {},
            data: {},

            async init() {
                this.setupEventListeners();
                await this.loadInitialData();
                this.renderCharts();
                await this.loadReports();
                this.startRealtimeUpdates();
            },

            setupEventListeners() {
                document.getElementById('dateRangeSelect').addEventListener('change', (e) => {
                    this.currentDateRange = e.target.value;
                    this.refreshData();
                });
            },

            async loadInitialData() {
                try {
                    await this.fetchMetrics();
                    this.updateMetricsDisplay();
                } catch (error) {
                    console.error('Failed to load initial data:', error);
                    this.showError('Failed to load analytics data');
                }
            },

            async fetchMetrics() {
                const response = await fetch(`/api/analytics/metrics?dateRange=${this.currentDateRange}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                this.data = result.data;
            },

            updateMetricsDisplay() {
                if (!this.data) return;

                // Update metric cards
                document.getElementById('totalLeadsValue').textContent = this.formatNumber(this.data.totalLeads);
                document.getElementById('totalRevenueValue').textContent = this.formatCurrency(this.data.totalRevenue);
                document.getElementById('conversionRateValue').textContent = (parseFloat(this.data.conversionRate) * 100).toFixed(1) + '%';
                document.getElementById('activeUsersValue').textContent = this.formatNumber(this.data.activeUsers);

                // Update change indicators (mock calculation)
                this.updateChangeIndicator('totalLeadsChange', 15.2);
                this.updateChangeIndicator('totalRevenueChange', 8.7);
                this.updateChangeIndicator('conversionRateChange', -2.1);
                this.updateChangeIndicator('activeUsersChange', 12.5);
            },

            updateChangeIndicator(elementId, change) {
                const element = document.getElementById(elementId);
                const span = element.querySelector('span');
                const arrow = element.querySelector('svg');

                span.textContent = `${Math.abs(change)}%`;

                if (change > 0) {
                    element.className = 'metric-change positive';
                    arrow.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>';
                } else if (change < 0) {
                    element.className = 'metric-change negative';
                    arrow.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>';
                } else {
                    element.className = 'metric-change neutral';
                    arrow.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14"></path>';
                }
            },

            renderCharts() {
                this.renderRevenueTrendChart();
                this.renderLeadSourcesChart();
                this.renderSalesFunnelChart();
                this.renderCampaignChart();
                this.renderUserActivityChart();
            },

            renderRevenueTrendChart() {
                const ctx = document.getElementById('revenueTrendChart').getContext('2d');

                if (this.charts.revenue) {
                    this.charts.revenue.destroy();
                }

                const trendData = this.data.revenueTrend || [];

                this.charts.revenue = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: trendData.map(d => new Date(d.date).toLocaleDateString()),
                        datasets: [{
                            label: 'Revenue',
                            data: trendData.map(d => d.value),
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => this.formatCurrency(value)
                                }
                            }
                        }
                    }
                });
            },

            renderLeadSourcesChart() {
                const ctx = document.getElementById('leadSourcesChart').getContext('2d');

                if (this.charts.sources) {
                    this.charts.sources.destroy();
                }

                const sourcesData = this.data.leadSources || [];

                this.charts.sources = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: sourcesData.map(d => d.label),
                        datasets: [{
                            data: sourcesData.map(d => d.value),
                            backgroundColor: [
                                'rgb(59, 130, 246)',
                                'rgb(16, 185, 129)',
                                'rgb(245, 158, 11)',
                                'rgb(139, 69, 193)',
                                'rgb(239, 68, 68)'
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            },

            renderSalesFunnelChart() {
                const ctx = document.getElementById('salesFunnelChart').getContext('2d');

                if (this.charts.funnel) {
                    this.charts.funnel.destroy();
                }

                const funnelData = this.data.salesFunnel || [];

                this.charts.funnel = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: funnelData.map(d => d.stage),
                        datasets: [{
                            label: 'Count',
                            data: funnelData.map(d => d.count),
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        }, {
                            label: 'Value',
                            data: funnelData.map(d => d.value),
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderColor: 'rgb(34, 197, 94)',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                display: true,
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false,
                                },
                                ticks: {
                                    callback: (value) => this.formatCurrency(value)
                                }
                            },
                        }
                    }
                });
            },

            renderCampaignChart() {
                const ctx = document.getElementById('campaignChart').getContext('2d');

                if (this.charts.campaign) {
                    this.charts.campaign.destroy();
                }

                // Mock campaign data
                const campaignData = {
                    labels: ['Email Open Rate', 'Click Rate', 'Conversion Rate'],
                    datasets: [{
                        label: 'Performance %',
                        data: [
                            parseFloat(this.data.emailOpenRate) * 100,
                            parseFloat(this.data.emailClickRate) * 100,
                            parseFloat(this.data.conversionRate) * 100
                        ],
                        backgroundColor: [
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(139, 69, 193, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgb(245, 158, 11)',
                            'rgb(139, 69, 193)',
                            'rgb(239, 68, 68)'
                        ],
                        borderWidth: 1
                    }]
                };

                this.charts.campaign = new Chart(ctx, {
                    type: 'bar',
                    data: campaignData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: (value) => value + '%'
                                }
                            }
                        }
                    }
                });
            },

            renderUserActivityChart() {
                const ctx = document.getElementById('userActivityChart').getContext('2d');

                if (this.charts.activity) {
                    this.charts.activity.destroy();
                }

                // Generate mock activity data for the last 7 days
                const activityData = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    activityData.push({
                        date: date.toLocaleDateString(),
                        logins: Math.floor(Math.random() * 50) + 10,
                        actions: Math.floor(Math.random() * 200) + 50
                    });
                }

                this.charts.activity = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: activityData.map(d => d.date),
                        datasets: [{
                            label: 'Logins',
                            data: activityData.map(d => d.logins),
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: false
                        }, {
                            label: 'Actions',
                            data: activityData.map(d => d.actions),
                            borderColor: 'rgb(139, 69, 193)',
                            backgroundColor: 'rgba(139, 69, 193, 0.1)',
                            borderWidth: 2,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            },

            async loadReports() {
                try {
                    const response = await fetch('/api/analytics/reports', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    this.renderReports(result.data);
                    this.populateExportOptions(result.data);
                } catch (error) {
                    console.error('Failed to load reports:', error);
                    this.showError('Failed to load reports');
                }
            },

            renderReports(reports) {
                const container = document.getElementById('reportsGrid');
                container.innerHTML = '';

                reports.forEach(report => {
                    const reportCard = document.createElement('div');
                    reportCard.className = 'report-card';
                    reportCard.onclick = () => this.executeReport(report.id);

                    reportCard.innerHTML = `
                        <div class="report-title">${report.name}</div>
                        <div class="report-description">${report.description}</div>
                        <div class="report-meta">
                            <span>Type: ${report.type}</span>
                            <span>${report.isDefault ? 'Default' : 'Custom'}</span>
                        </div>
                    `;

                    container.appendChild(reportCard);
                });
            },

            populateExportOptions(reports) {
                const select = document.getElementById('exportReport');
                select.innerHTML = '<option value="">Select a report...</option>';

                reports.forEach(report => {
                    const option = document.createElement('option');
                    option.value = report.id;
                    option.textContent = report.name;
                    select.appendChild(option);
                });
            },

            async executeReport(reportId) {
                try {
                    const response = await fetch(`/api/analytics/reports/${reportId}/execute`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            parameters: {
                                dateRange: this.currentDateRange
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    this.displayReportResults(result.data);
                } catch (error) {
                    console.error('Failed to execute report:', error);
                    this.showError('Failed to execute report');
                }
            },

            displayReportResults(results) {
                // For now, just show an alert. In a full implementation,
                // this would open a modal with formatted results
                alert(`Report executed successfully!\nGenerated at: ${new Date(results.executedAt).toLocaleString()}`);
            },

            startRealtimeUpdates() {
                // Update metrics every 30 seconds
                setInterval(() => {
                    this.updateRealtimeMetrics();
                }, 30000);
            },

            async updateRealtimeMetrics() {
                try {
                    const response = await fetch('/api/analytics/metrics/realtime', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });

                    if (!response.ok) return;

                    const result = await response.json();
                    // Update real-time indicators here
                } catch (error) {
                    console.error('Failed to update realtime metrics:', error);
                }
            },

            formatNumber(num) {
                if (typeof num !== 'number') return '---';
                return new Intl.NumberFormat().format(num);
            },

            formatCurrency(amount) {
                if (typeof amount !== 'number') return '---';
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(amount);
            },

            showError(message) {
                // Simple error display - in a full app, this would be more sophisticated
                console.error(message);
                // You could show a toast notification or error banner here
            }
        };

        // Global functions for UI interactions
        async function refreshData() {
            await AnalyticsApp.fetchMetrics();
            AnalyticsApp.updateMetricsDisplay();
            AnalyticsApp.renderCharts();
        }

        function toggleChartType(chartType) {
            // Toggle between chart types (line/bar, pie/doughnut, etc.)
            // Implementation would depend on specific requirements
            console.log(`Toggling chart type for: ${chartType}`);
        }

        function refreshFunnel() {
            AnalyticsApp.renderSalesFunnelChart();
        }

        function createCustomReport() {
            alert('Custom report builder would open here');
        }

        function openExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        async function executeExport() {
            const reportId = document.getElementById('exportReport').value;
            const format = document.getElementById('exportFormat').value;
            const dateRange = document.getElementById('exportDateRange').value;

            if (!reportId) {
                alert('Please select a report to export');
                return;
            }

            try {
                const response = await fetch(`/api/analytics/export/${reportId}?format=${format}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `analytics-export-${reportId}.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);

                closeExportModal();
            } catch (error) {
                console.error('Export failed:', error);
                alert('Export failed. Please try again.');
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            AnalyticsApp.init();
        });
    </script>
</body>
</html>