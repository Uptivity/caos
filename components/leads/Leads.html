<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leads - CAOS CRM</title>
    <link rel="stylesheet" href="../../styles/snowui.css">
    <link rel="stylesheet" href="../shared/components.css">
    <link rel="stylesheet" href="../shared/navigation.css">
</head>
<body>
    <div id="page-content">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-content">
                <h1 class="page-title">Leads Management</h1>
                <p class="page-description">Manage and track your sales leads</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-secondary" onclick="exportToCSV()" aria-label="Export leads to CSV">
                    <span>ðŸ“¥</span> Export CSV
                </button>
                <button class="btn btn-primary" onclick="showCreateModal()" aria-label="Create new lead">
                    <span>+</span> New Lead
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ðŸ‘¥</div>
                <div class="stat-content">
                    <div class="stat-label">Total Leads</div>
                    <div class="stat-value" id="stat-total">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âœ“</div>
                <div class="stat-content">
                    <div class="stat-label">Qualified</div>
                    <div class="stat-value" id="stat-qualified">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ðŸ’°</div>
                <div class="stat-content">
                    <div class="stat-label">Won</div>
                    <div class="stat-value" id="stat-won">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ðŸ“ˆ</div>
                <div class="stat-content">
                    <div class="stat-label">Conversion Rate</div>
                    <div class="stat-value" id="stat-conversion">0%</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-bar">
            <div class="filter-group">
                <label for="filter-status" class="sr-only">Filter by status</label>
                <select id="filter-status" class="form-select" onchange="filterLeads()">
                    <option value="">All Status</option>
                    <option value="new">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="qualified">Qualified</option>
                    <option value="negotiation">Negotiation</option>
                    <option value="won">Won</option>
                    <option value="lost">Lost</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-source" class="sr-only">Filter by source</label>
                <select id="filter-source" class="form-select" onchange="filterLeads()">
                    <option value="">All Sources</option>
                    <option value="website">Website</option>
                    <option value="referral">Referral</option>
                    <option value="social">Social Media</option>
                    <option value="email">Email Campaign</option>
                    <option value="event">Event</option>
                </select>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card">
            <div id="leads-table-container"></div>
        </div>
    </div>

    <script src="../utils/apiClient.js"></script>
    <script src="../shared/components.js"></script>
    <script src="../shared/navigation.js"></script>
    <script>
        // Authentication check
        if (!apiClient.isAuthenticated()) {
            window.location.href = '../auth/login.html';
        }

        // Global state
        let allLeads = [];
        let dataTable = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            await loadLeads();
        });

        // Load leads from API
        async function loadLeads() {
            try {
                LoadingSpinner.show('Loading leads...');
                const response = await apiClient.get('/api/leads');

                // Handle different response formats
                allLeads = Array.isArray(response) ? response : (response.leads || response.data || []);

                updateStats();
                renderTable();
                LoadingSpinner.hide();
            } catch (error) {
                LoadingSpinner.hide();
                Toast.show('Failed to load leads: ' + error.message, 'error');
                console.error('Load leads error:', error);
            }
        }

        // Update statistics
        function updateStats() {
            const total = allLeads.length;
            const qualified = allLeads.filter(l => l.status === 'qualified').length;
            const won = allLeads.filter(l => l.status === 'won').length;
            const conversion = total > 0 ? Math.round((won / total) * 100) : 0;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-qualified').textContent = qualified;
            document.getElementById('stat-won').textContent = won;
            document.getElementById('stat-conversion').textContent = conversion + '%';
        }

        // Render data table
        function renderTable() {
            dataTable = new DataTable({
                columns: [
                    {
                        label: 'Name',
                        field: 'name',
                        render: (value, row) => {
                            const firstName = row.firstName || '';
                            const lastName = row.lastName || '';
                            return `${firstName} ${lastName}`.trim() || 'N/A';
                        }
                    },
                    { label: 'Email', field: 'email' },
                    { label: 'Phone', field: 'phone' },
                    { label: 'Company', field: 'company' },
                    {
                        label: 'Status',
                        field: 'status',
                        render: (value) => {
                            const badges = {
                                new: '<span class="badge badge-info">New</span>',
                                contacted: '<span class="badge badge-primary">Contacted</span>',
                                qualified: '<span class="badge badge-success">Qualified</span>',
                                negotiation: '<span class="badge badge-warning">Negotiation</span>',
                                won: '<span class="badge badge-success">Won</span>',
                                lost: '<span class="badge badge-danger">Lost</span>'
                            };
                            return badges[value] || value;
                        }
                    },
                    {
                        label: 'Source',
                        field: 'source',
                        render: (value) => value || 'N/A'
                    },
                    {
                        label: 'Actions',
                        field: 'id',
                        sortable: false,
                        render: (value, row) => `
                            <div class="table-actions">
                                <button class="btn btn-sm btn-secondary"
                                        onclick="showEditModal('${value}')"
                                        aria-label="Edit lead">
                                    Edit
                                </button>
                                <button class="btn btn-sm btn-danger"
                                        onclick="deleteLead('${value}')"
                                        aria-label="Delete lead">
                                    Delete
                                </button>
                            </div>
                        `
                    }
                ],
                data: allLeads,
                searchable: true,
                sortable: true,
                pagination: true,
                pageSize: 10
            });

            dataTable.render('leads-table-container');
        }

        // Filter leads
        function filterLeads() {
            const statusFilter = document.getElementById('filter-status').value;
            const sourceFilter = document.getElementById('filter-source').value;

            let filtered = allLeads;

            if (statusFilter) {
                filtered = filtered.filter(l => l.status === statusFilter);
            }

            if (sourceFilter) {
                filtered = filtered.filter(l => l.source === sourceFilter);
            }

            dataTable.updateData(filtered);
            dataTable.render('leads-table-container');
        }

        // Show create modal
        async function showCreateModal() {
            const formBuilder = new FormBuilder([
                {
                    name: 'firstName',
                    label: 'First Name',
                    type: 'text',
                    required: true,
                    validation: { minLength: 2 }
                },
                {
                    name: 'lastName',
                    label: 'Last Name',
                    type: 'text',
                    required: true,
                    validation: { minLength: 2 }
                },
                {
                    name: 'email',
                    label: 'Email',
                    type: 'email',
                    required: true,
                    validation: { email: true }
                },
                {
                    name: 'phone',
                    label: 'Phone',
                    type: 'tel',
                    placeholder: '+1 (555) 123-4567'
                },
                {
                    name: 'company',
                    label: 'Company',
                    type: 'text'
                },
                {
                    name: 'status',
                    label: 'Status',
                    type: 'select',
                    required: true,
                    options: [
                        { value: 'new', label: 'New' },
                        { value: 'contacted', label: 'Contacted' },
                        { value: 'qualified', label: 'Qualified' },
                        { value: 'negotiation', label: 'Negotiation' },
                        { value: 'won', label: 'Won' },
                        { value: 'lost', label: 'Lost' }
                    ]
                },
                {
                    name: 'source',
                    label: 'Source',
                    type: 'select',
                    options: [
                        { value: 'website', label: 'Website' },
                        { value: 'referral', label: 'Referral' },
                        { value: 'social', label: 'Social Media' },
                        { value: 'email', label: 'Email Campaign' },
                        { value: 'event', label: 'Event' }
                    ]
                },
                {
                    name: 'notes',
                    label: 'Notes',
                    type: 'textarea',
                    placeholder: 'Add any additional notes...'
                }
            ]);

            const modal = new Modal({
                title: 'Create New Lead',
                content: `<form id="createLeadForm">${formBuilder.render()}</form>`,
                confirmText: 'Create Lead',
                size: 'large',
                onConfirm: async () => {
                    const form = document.getElementById('createLeadForm');
                    if (formBuilder.validate(form)) {
                        const data = formBuilder.getData(form);
                        try {
                            LoadingSpinner.show('Creating lead...');
                            await apiClient.post('/api/leads', data);
                            Toast.show('Lead created successfully!', 'success');
                            await loadLeads();
                            LoadingSpinner.hide();
                        } catch (error) {
                            LoadingSpinner.hide();
                            Toast.show('Failed to create lead: ' + error.message, 'error');
                            throw error; // Prevent modal from closing
                        }
                    } else {
                        throw new Error('Validation failed'); // Prevent modal from closing
                    }
                }
            });
            modal.show();
        }

        // Show edit modal
        async function showEditModal(leadId) {
            try {
                LoadingSpinner.show('Loading lead...');
                const lead = allLeads.find(l => l.id === leadId);
                LoadingSpinner.hide();

                if (!lead) {
                    Toast.show('Lead not found', 'error');
                    return;
                }

                const formBuilder = new FormBuilder([
                    {
                        name: 'firstName',
                        label: 'First Name',
                        type: 'text',
                        required: true,
                        value: lead.firstName || '',
                        validation: { minLength: 2 }
                    },
                    {
                        name: 'lastName',
                        label: 'Last Name',
                        type: 'text',
                        required: true,
                        value: lead.lastName || '',
                        validation: { minLength: 2 }
                    },
                    {
                        name: 'email',
                        label: 'Email',
                        type: 'email',
                        required: true,
                        value: lead.email || '',
                        validation: { email: true }
                    },
                    {
                        name: 'phone',
                        label: 'Phone',
                        type: 'tel',
                        value: lead.phone || ''
                    },
                    {
                        name: 'company',
                        label: 'Company',
                        type: 'text',
                        value: lead.company || ''
                    },
                    {
                        name: 'status',
                        label: 'Status',
                        type: 'select',
                        required: true,
                        value: lead.status || 'new',
                        options: [
                            { value: 'new', label: 'New' },
                            { value: 'contacted', label: 'Contacted' },
                            { value: 'qualified', label: 'Qualified' },
                            { value: 'negotiation', label: 'Negotiation' },
                            { value: 'won', label: 'Won' },
                            { value: 'lost', label: 'Lost' }
                        ]
                    },
                    {
                        name: 'source',
                        label: 'Source',
                        type: 'select',
                        value: lead.source || '',
                        options: [
                            { value: 'website', label: 'Website' },
                            { value: 'referral', label: 'Referral' },
                            { value: 'social', label: 'Social Media' },
                            { value: 'email', label: 'Email Campaign' },
                            { value: 'event', label: 'Event' }
                        ]
                    },
                    {
                        name: 'notes',
                        label: 'Notes',
                        type: 'textarea',
                        value: lead.notes || ''
                    }
                ]);

                const modal = new Modal({
                    title: 'Edit Lead',
                    content: `<form id="editLeadForm">${formBuilder.render()}</form>`,
                    confirmText: 'Update Lead',
                    size: 'large',
                    onConfirm: async () => {
                        const form = document.getElementById('editLeadForm');
                        if (formBuilder.validate(form)) {
                            const data = formBuilder.getData(form);
                            try {
                                LoadingSpinner.show('Updating lead...');
                                await apiClient.put(`/api/leads/${leadId}`, data);
                                Toast.show('Lead updated successfully!', 'success');
                                await loadLeads();
                                LoadingSpinner.hide();
                            } catch (error) {
                                LoadingSpinner.hide();
                                Toast.show('Failed to update lead: ' + error.message, 'error');
                                throw error;
                            }
                        } else {
                            throw new Error('Validation failed');
                        }
                    }
                });
                modal.show();
            } catch (error) {
                LoadingSpinner.hide();
                Toast.show('Error loading lead: ' + error.message, 'error');
            }
        }

        // Delete lead
        async function deleteLead(leadId) {
            const modal = new Modal({
                title: 'Delete Lead',
                content: '<p>Are you sure you want to delete this lead? This action cannot be undone.</p>',
                confirmText: 'Delete',
                cancelText: 'Cancel',
                onConfirm: async () => {
                    try {
                        LoadingSpinner.show('Deleting lead...');
                        await apiClient.delete(`/api/leads/${leadId}`);
                        Toast.show('Lead deleted successfully!', 'success');
                        await loadLeads();
                        LoadingSpinner.hide();
                    } catch (error) {
                        LoadingSpinner.hide();
                        Toast.show('Failed to delete lead: ' + error.message, 'error');
                    }
                }
            });
            modal.show();
        }

        // Export to CSV
        function exportToCSV() {
            if (allLeads.length === 0) {
                Toast.show('No leads to export', 'warning');
                return;
            }

            const headers = ['First Name', 'Last Name', 'Email', 'Phone', 'Company', 'Status', 'Source', 'Notes'];
            const rows = allLeads.map(lead => [
                lead.firstName || '',
                lead.lastName || '',
                lead.email || '',
                lead.phone || '',
                lead.company || '',
                lead.status || '',
                lead.source || '',
                lead.notes || ''
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `leads_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            Toast.show('Leads exported successfully!', 'success');
        }
    </script>
</body>
</html>
